<!DOCTYPE html>
<head>
<title>JS Robots!</title>

<style>
.player {
	position: absolute;
	background-color: blue;
	font-size: 24pt;
	color: white;
	font-weight: bold;
	padding: 0.2em;
	font-family: monospace;
}
</style>
</head>
<body>

<div id='container'></div>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
var players = [];

var nextPlayerId = 1;
function addPlayer(generator){
	var player = {
		id: nextPlayerId++,
		position: {
			x: Math.floor(Math.random() * window.innerWidth),
			y: Math.floor(Math.random() * window.innerHeight)
		},
	};

	var speed = 10;

	var io = {
		move(degrees){
			if (typeof degrees === 'number'){
				this.current.move = degrees;
			}
			else {
				this.current.move = null;
			}

			return this;
		},
		current: {}
	};

	player.io = io;
	player.iterator = generator(io);
	players.push(player);
}

function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function constrainPosition(max, actual){
	if (actual > max){
		return max;
	}
	else if (actual < 0){
		return 0;
	}
	else {
		return actual;
	}
}

async function run(){
	const speed = 10;

	while (true){
		var startingPositions =
			players
			.map(p => Object.freeze({
				id: p.id,
				position: Object.freeze(Object.assign({}, p.position))
			}));

		var container = d3.select('#container');

		for (var player of players){
			player.io.positions = startingPositions;
			player.io.arena = {
				width: window.innerWidth,
				height: window.innerHeight
			};

			var io = player.iterator.next().value;

			if (typeof io.current.move === 'number'){
				let degrees = io.current.move;
				player.position.x = constrainPosition(player.io.arena.width, player.position.x + (speed * Math.cos(degrees * Math.PI / 180)));
				player.position.y = constrainPosition(player.io.arena.height, player.position.y + (speed * Math.sin(degrees * Math.PI / 180)));
			}

			//console.log(`player ${player.id}: x: ${player.position.x}, y: ${player.position.y}`);
		}

		var sel =
			container
			.selectAll('div.player')
			.data(players);

		sel.enter()
			.append('div')
				.attr('class', 'player')
				.text(d => d.id)
				.style('opacity', 1e-6)
			.transition()
				.duration(1000)
				.style('opacity', 1.0);

		sel
			.style('left', d => d.position.x + 'px')
			.style('top', d => d.position.y + 'px');

		await timeout(100);
	}
}

run();

/*
game code above   ^^^^^^^^
player code below vvvvvvvv
*/



function* samplePlayer1(io){
	var angle = 0;
	while (true){
		angle += Math.random() * 90 - 45;
		io.move(angle);

		yield io;
	}
}

function* samplePlayer2(io){
	while (true){
		console.log(io.arena);
		yield io.move(120);
	}
}

addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);

</script>
</body>
</html>
