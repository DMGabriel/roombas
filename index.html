<!DOCTYPE html>
<head>
<title>JS Robots!</title>

<style>
.player circle {
	fill: blue;
}

.player text {
	fill: white;
	font-size: 32px;
	font-family: monospace;
	text-decoration: underline;
}

#container {
    position: fixed;
    top: 0px;
    left: 0px;
    width: 100vw;
    height: 100vh;
}

button {
	position: fixed;
}
</style>
</head>
<body>

<svg id='container'>
</svg>

<button id='stop'>Stop</button>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
var players = [];

var nextPlayerId = 1;
function addPlayer(generator){
	var player = {
		id: nextPlayerId++,
		position: {
			x: Math.floor(Math.random() * window.innerWidth),
			y: Math.floor(Math.random() * window.innerHeight)
		},
	};

	var io = {
		move(degrees){
			this.current.move = degrees;
			return this;
		},
		rotate(degrees){
			this.current.rotate = degrees;
			return this;
		},
		current: {
			rotate: 0
		}
	};

	player.io = io;
	player.iterator = generator(io);
	players.push(player);
}

function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function constrainPosition(max, actual){
	const padding = 30;
	max -= padding;

	if (actual > max){
		return max;
	}
	else if (actual < padding){
		return padding;
	}
	else {
		return actual;
	}
}

var stopped = false;
document.getElementById('stop').addEventListener('click', () => stopped = true);

async function run(){
	const speed = 10;
	const interval = 100;

	while (!stopped){
		var startingPositions =
			players
			.map(p => Object.freeze({
				id: p.id,
				position: Object.freeze(Object.assign({}, p.position))
			}));

		var container =
			d3.select('#container')
			//.attr(

		var sel =
			container
			.selectAll('.player')
			.data(players);

		var g =
			sel.enter()
			.append('g')
				.attr('class', 'player')
				.style('opacity', 1e-6)
				.each(function(d){ d.element = this });

		g.append('circle')
			.attr('r', 30)
			.attr('cx', 5)
			.attr('cy', 5);

		g.append('text')
			.attr('text-anchor', 'middle')
			.attr('transform', 'translate(0, 10)')
			.text(d => d.id);

		g.transition('fadein')
			.duration(1000)
			.style('opacity', 1.0);

		for (var player of players){
			player.io.positions = startingPositions;
			player.io.arena = {
				width: window.innerWidth,
				height: window.innerHeight
			};

			var io = player.iterator.next().value;

			if (typeof io.current.move === 'number'){
				let degrees = io.current.move;
				let bbox = player.element.getBoundingClientRect();
				player.position.x = Math.floor(
					constrainPosition(
						player.io.arena.width,
						player.position.x + (speed * Math.cos(degrees * Math.PI / 180))
					)
				);

				player.position.y = Math.floor(
					constrainPosition(
						player.io.arena.height,
						player.position.y + (speed * Math.sin(degrees * Math.PI / 180))
					)
				);
			}
		}

		sel
			.transition()
			.duration(interval)
			.attr('transform', d => `translate(${d.position.x},${d.position.y}) rotate(${Math.floor(d.io.current.rotate)})`)

		await timeout(interval);
	}

	console.warn('stopped');
}

run();

/*
game code above   ^^^^^^^^
player code below vvvvvvvv
*/



function* samplePlayer1(io){
	var angle = 0;
	while (true){
		angle += Math.random() * 50 - 25;
		yield io.move(angle).rotate(angle);
	}
}

function* samplePlayer2(io){
	while (true){
		console.log(io.arena);
		yield io.move(120);
	}
}

addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);

</script>
</body>
</html>
