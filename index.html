<!DOCTYPE html>
<head>
<title>Roomba Battle</title>

<style>
.player .body {
	fill: rgb(192, 192, 255);
}

.player .head {
	fill: rgb(100, 100, 255);
}

.player text {
	fill: white;
	font-size: 32px;
	font-family: monospace;
	text-decoration: underline;
}

#container {
    position: fixed;
    top: 0px;
    left: 0px;
    width: 100vw;
    height: 100vh;
}

button {
	position: fixed;
}
</style>
</head>
<body>

<script src="https://d3js.org/d3.v4.min.js"></script>

<svg id='container'></svg>
<button id='stop'>Stop</button>

<script>
const roombaRadius = 30;
const speed = 10;
const frameRate = Math.trunc(1000 / 30);
const players = [];

var nextPlayerId = 1;

function addPlayer(generator){
	const player = {
		id: nextPlayerId++,
		position: {
			x: Math.floor(Math.random() * window.innerWidth),
			y: Math.floor(Math.random() * window.innerHeight)
		},
		io: {
			angle: 0
		}
	};

	player.iterator = generator(player.io);
	players.push(player);
}

function constrainPosition(max, actual){
	const padding = roombaRadius;
	max -= padding;

	if (actual > max){
		return max;
	}
	else if (actual < padding){
		return padding;
	}
	else {
		return actual;
	}
}

var stopped = false;
document.getElementById('stop').addEventListener('click', () => stopped = true);

const container = d3.select('#container');

async function run(){
	while (!stopped){
		const startingPositions =
			Object.freeze(
				players
				.map(p => Object.freeze({
					id: p.id,
					position: Object.freeze(Object.assign({}, p.position))
				}))
			);

		const dataJoin = container.selectAll('.player').data(players);

		const g =
			dataJoin.enter()
			.append('g')
				.attr('class', 'player')
				.style('opacity', 1e-6)
				.each(function(d){ d.element = this });

		g.append('circle')
			.attr('class', 'body')
			.attr('r', roombaRadius)
			.attr('cx', 0)
			.attr('cy', 0);

		g.append('circle')
			.attr('class', 'head')
			.attr('r', 5)
			.attr('cx', roombaRadius)
			.attr('cy', 0);

		g.append('text')
			.attr('text-anchor', 'middle')
			.attr('transform', 'translate(0, 8)')
			.text(d => d.id);

		g.transition('fadein')
			.duration(1000)
			.style('opacity', 1.0);

		for (let player of players){
			const io = player.io;

			io.move = null;
			io.positions = startingPositions;
			io.arena = {
				width: window.innerWidth,
				height: window.innerHeight
			};

			player.iterator.next();

			// security check
			if (typeof io.angle !== 'number'){
				io.angle = 0;
			}

			if (typeof io.move === 'number'){
				const degrees = io.move;
				const bbox = player.element.getBoundingClientRect();
				player.position.x = Math.floor(
					constrainPosition(
						io.arena.width,
						player.position.x + (speed * Math.cos(degrees * Math.PI / 180))
					)
				);

				player.position.y = Math.floor(
					constrainPosition(
						io.arena.height,
						player.position.y + (speed * Math.sin(degrees * Math.PI / 180))
					)
				);
			}
		}

		dataJoin.attr('transform', d => `translate(${d.position.x},${d.position.y}) rotate(${Math.floor(d.io.angle)})`)

		await timeout(frameRate);
	}

	console.warn('stopped');
}

function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

run();

/*
game code above   ↑↑↑↑↑ 
player code below ↓↓↓↓↓
*/



function* samplePlayer1(io){
	while (true){
		io.angle += Math.random() * 20 - 10;
		io.move = io.angle;
		yield;
	}
}

function* samplePlayer2(io){
	while (true){
		io.move = 10;
		yield;
	}
}

addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);
addPlayer(samplePlayer1);

</script>
</body>
</html>
